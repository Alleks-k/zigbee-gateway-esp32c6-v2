<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zigbee Gateway</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="card">
            <h2>Gateway Status <span id="ws-status" style="float:right; font-size:0.8em; color:red; display:flex; align-items:center; gap:5px;"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-2h2v2h-2zm0-10v6h2V7h-2z"/></svg> Offline</span></h2>
            <div class="status-grid">
                <div class="status-item">
                    <strong>PAN ID:</strong> <span id="panId">Loading...</span>
                </div>
                <div class="status-item">
                    <strong>Channel:</strong> <span id="channel">--</span>
                </div>
                <div class="status-item">
                    <strong>Address:</strong> <span id="gwAddr">--</span>
                </div>
                <div class="status-item">
                    <strong>Zigbee:</strong> <span id="zbStarted">--</span>
                </div>
                <div class="status-item">
                    <strong>Wi-Fi:</strong> <span id="wifiState">--</span>
                </div>
                <div class="status-item">
                    <strong>NVS Schema:</strong> <span id="nvsSchema">--</span>
                </div>
                <div class="status-item">
                    <strong>Heap Free:</strong> <span id="heapFree">--</span>
                </div>
                <div class="status-item">
                    <strong>Heap Min:</strong> <span id="heapMinFree">--</span>
                </div>
                <div class="status-item">
                    <strong>Uptime:</strong> <span id="uptime">--</span>
                </div>
                <div class="status-item">
                    <strong>Wi-Fi RSSI:</strong> <span id="wifiRssi">--</span>
                </div>
                <div class="status-item">
                    <strong>Temp:</strong> <span id="chipTemp">N/A</span>
                </div>
            </div>
            <div id="backend-mode-badge" class="backend-mode-badge mode-unknown">Backend mode: detecting...</div>
            <button id="permitJoinBtn" class="btn-permit"><svg class="icon" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Permit Join (60s)</button>
        </div>

        <div class="card">
            <h2>Zigbee Devices</h2>
            <ul id="deviceList">
                <li class="empty">Scanning for devices...</li>
            </ul>
        </div>

        <div class="card">
            <h2>LQI Map <button id="refreshLqiBtn" class="btn" style="float:right; padding:4px 8px; font-size:0.8rem;"><svg class="icon" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4V1L7 6l5 5V7c2.76 0 5 2.24 5 5 0 1.57-.73 2.97-1.86 3.88l1.42 1.42C18.07 16.04 19 14.13 19 12c0-2.21-.9-4.21-2.35-5.65zM6 12c0-1.57.73-2.97 1.86-3.88L6.44 6.7C4.93 7.96 4 9.87 4 12c0 2.21.9 4.21 2.35 5.65C7.8 19.1 9.79 20 12 20v3l5-5-5-5v3c-2.76 0-5-2.24-5-5z"/></svg> Refresh</button></h2>
            <div class="lqi-meta">
                <span><strong>Source:</strong> <span id="lqiSource">--</span></span>
                <span><strong>Updated:</strong> <span id="lqiUpdated">--</span></span>
                <span id="lqiStaleBadge" class="lqi-stale-badge ok">fresh</span>
            </div>
            <div class="lqi-wrap">
                <table class="lqi-table">
                    <thead>
                        <tr>
                            <th>Device</th>
                            <th>Addr</th>
                            <th>LQI</th>
                            <th>Age</th>
                            <th>RSSI</th>
                            <th>Quality</th>
                            <th>Trend (15m)</th>
                            <th>Link</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody id="lqiTableBody">
                        <tr><td colspan="9" class="lqi-empty">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="lqi-graph-wrap">
                <h3 class="lqi-graph-title">LQI Graph (MVP)</h3>
                <div id="lqiGraph" class="lqi-graph">
                    <div class="lqi-graph-empty">No LQI graph data</div>
                </div>
            </div>
            <div class="lqi-hints-wrap">
                <h3 class="lqi-graph-title">Router Hints (MVP)</h3>
                <ul id="lqiHints" class="lqi-hints">
                    <li class="hint-empty">No hints yet</li>
                </ul>
            </div>
        </div>
<div class="card">
    <h2>Налаштування Wi-Fi</h2>
    <div class="form-group">
        <label for="wifi-ssid">SSID Мережі</label>
        <div class="input-row">
            <input type="text" id="wifi-ssid" placeholder="Введіть назву або скануйте">
            <button id="scanWifiBtn" onclick="scanWifi()" class="btn"><svg class="icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg> Сканувати</button>
        </div>
        <!-- Контейнер для результатів сканування -->
        <div id="wifi-scan-results" class="scan-results" style="display:none;"></div>
    </div>
    
    <div class="form-group">
        <label for="wifi-pass">Пароль</label>
        <input type="password" id="wifi-pass" placeholder="Введіть пароль">
    </div>
    
    <button onclick="saveWifiSettings()" class="btn btn-primary"><svg class="icon" viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg> Зберегти та підключитись</button>
</div>

        <div class="card">
            <h2>System</h2>
            <p>Керування живленням шлюзу.</p>
            <button id="rebootBtn" onclick="rebootGateway()" class="btn-del" style="width: 100%;"><svg class="icon" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg> Reboot Gateway</button>
            <button id="factoryResetBtn" onclick="factoryResetGateway()" class="btn-del" style="width: 100%; margin-top: 8px;"><svg class="icon" viewBox="0 0 24 24"><path d="M12 5V2L7 6l5 4V7c2.76 0 5 2.24 5 5 0 1.64-.8 3.09-2.02 4H17c1.26-1.27 2-3.01 2-5 0-3.87-3.13-7-7-7zm-5 7c0-1.64.8-3.09 2.02-4H7c-1.26 1.27-2 3.01-2 5 0 3.87 3.13 7 7 7v3l5-4-5-4v3c-2.76 0-5-2.24-5-5z"/></svg> Factory Reset</button>
        </div>
    </div>

    <div id="job-indicator" class="job-indicator" style="display:none;">
        <div class="job-indicator-row">
            <strong id="job-indicator-op">Operation</strong>
            <span id="job-indicator-state" class="job-state queued">queued</span>
        </div>
        <small id="job-indicator-detail"></small>
    </div>
    
    <!-- Контейнер для спливаючих повідомлень -->
    <div id="toast">Some text some message..</div>

    <!-- Модальне вікно підтвердження -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <p id="confirmMessage">Are you sure?</p>
            <div class="modal-buttons">
                <button id="confirmYes" class="btn btn-primary">Так</button>
                <button id="confirmNo" class="btn btn-del">Ні</button>
            </div>
        </div>
    </div>

    <!-- Модальне вікно редагування -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>Rename Device</h3>
            <input type="text" id="editNameInput" placeholder="New Name" style="width: 80%; padding: 8px; margin: 10px 0;">
            <input type="hidden" id="editAddrInput">
            <div class="modal-buttons">
                <button onclick="saveDeviceName()" class="btn btn-primary">Save</button>
                <button onclick="closeEditModal()" class="btn btn-del">Cancel</button>
            </div>
        </div>
    </div>

<script src="script.js"></script>
</body>
</html>
